<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Messenger Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 max-w-7xl bg-white rounded-2xl shadow-xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Secure Messenger Simulation</h1>
            <p class="text-gray-500 mt-1">A visual walkthrough of your secure communication flowchart.</p>
        </header>

        <!-- Main communication panel with 3 columns -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- ALICE (SENDER) PANEL -->
            <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                <h2 class="text-2xl font-semibold text-blue-800 mb-4">Alice (Sender)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="message-input" class="block text-sm font-medium text-gray-700">Your Message:</label>
                        <textarea id="message-input" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Type your secret message here..."></textarea>
                    </div>
                    <button id="send-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                        Send Secure Message
                    </button>
                    <div id="alice-log" class="mt-4 p-4 bg-white rounded-lg text-sm space-y-2 border border-blue-100 h-48 overflow-y-auto">
                        <p class="text-gray-400">Alice's actions will appear here...</p>
                    </div>
                </div>
            </div>

            <!-- MAN-IN-THE-MIDDLE (ATTACKER) PANEL -->
            <div class="flex flex-col items-center justify-center bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4 text-center">Communication Channel</h2>
                <div id="transmission-display" class="mb-4 p-3 w-full bg-white rounded-lg border border-gray-300 h-24 overflow-hidden text-xs text-gray-500">
                    Waiting for message...
                </div>
                 <button id="tamper-button" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-300" disabled>
                    üòà Tamper Message!
                </button>
            </div>

            <!-- BOB (RECEIVER) PANEL -->
            <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                <h2 class="text-2xl font-semibold text-green-800 mb-4">Bob (Receiver)</h2>
                <div class="space-y-4">
                    <button id="receive-button" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-300" disabled>
                        Receive & Verify Message
                    </button>
                    <div id="bob-log" class="mt-4 p-4 bg-white rounded-lg text-sm space-y-2 border border-green-100 h-64 overflow-y-auto">
                       <p class="text-gray-400">Bob's actions will appear here...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP: Elements and Cryptography Keys ---
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const receiveButton = document.getElementById('receive-button');
        const tamperButton = document.getElementById('tamper-button');
        const transmissionDisplay = document.getElementById('transmission-display');
        const aliceLog = document.getElementById('alice-log');
        const bobLog = document.getElementById('bob-log');
        
        let transmittedData = {};

        const log = (panel, message, icon) => {
            const p = document.createElement('p');
            p.innerHTML = `${icon} ${message}`;
            if (panel.firstChild && panel.firstChild.textContent.includes("actions will appear here...")) {
                panel.innerHTML = '';
            }
            panel.appendChild(p);
            panel.scrollTop = panel.scrollHeight;
        };

        const alice = new JSEncrypt({ default_key_size: 1024 });
        const bob = new JSEncrypt({ default_key_size: 1024 });
        const alicePublicKey = alice.getPublicKey();
        const bobPublicKey = bob.getPublicKey();
        const alicePrivateKey = alice.getPrivateKey();
        const bobPrivateKey = bob.getPrivateKey();

        log(aliceLog, 'Generated my RSA key pair.', 'üîë');
        log(bobLog, 'Generated my RSA key pair.', 'üîë');

        // --- 2. SENDER LOGIC (ALICE) ---
        sendButton.addEventListener('click', () => {
            const message = messageInput.value;
            if (!message) { alert('Please enter a message.'); return; }

            if (message.length > 100) {
                alert('Message is too long for 1024-bit RSA encryption (max ~100 characters).');
                return;
            }

            aliceLog.innerHTML = '';
            log(aliceLog, `Original Message: "${message}"`, 'üí¨');
            
            const hashHex = CryptoJS.SHA256(message).toString(CryptoJS.enc.Hex);
            log(aliceLog, `Hashed message (SHA-256): ${hashHex.substring(0,20)}...`, 'üßÆ');

            const signer = new JSEncrypt();
            signer.setPrivateKey(alicePrivateKey);
            const signature = signer.sign(message, CryptoJS.SHA256, 'sha256');
            
            if (!signature) { log(aliceLog, 'ERROR: Could not create signature.', '‚ùå'); return; }
            log(aliceLog, 'Signed the message with my private key.', '‚úçÔ∏è');
            
            const encryptor = new JSEncrypt();
            encryptor.setPublicKey(bobPublicKey);
            const encryptedMessage = encryptor.encrypt(message);

            if (!encryptedMessage) { log(aliceLog, 'ERROR: Encryption failed.', '‚ùå'); return; }
            log(aliceLog, 'Encrypted message with Bob\'s public key.', 'üîí');

            transmittedData = { encryptedMessage, signature };
            
            transmissionDisplay.textContent = `Encrypted: ${encryptedMessage.substring(0, 50)}...\nSignature: ${signature.substring(0, 50)}...`;
            log(aliceLog, 'Transmission sent!', 'üöÄ');
            
            receiveButton.disabled = false;
            tamperButton.disabled = false;
            tamperButton.textContent = 'üòà Tamper Message!';
            tamperButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            tamperButton.classList.add('bg-red-600', 'hover:bg-red-700');
            transmissionDisplay.classList.remove('bg-red-100', 'border-red-400');

            bobLog.innerHTML = '<p class="text-gray-400">Incoming transmission! Ready to receive and verify.</p>';
        });

        // --- 3. TAMPERING LOGIC ---
        tamperButton.addEventListener('click', () => {
             if (transmittedData.encryptedMessage) {
                // FIX: Corrupt the ciphertext by changing a character in the middle.
                // This is a much more effective way to break the encryption.
                const middle = Math.floor(transmittedData.encryptedMessage.length / 2);
                let tamperedCipher = transmittedData.encryptedMessage.substring(0, middle) + 'Z' + transmittedData.encryptedMessage.substring(middle + 1);
                transmittedData.encryptedMessage = tamperedCipher;
                
                tamperButton.textContent = 'Tampered ‚úì';
                tamperButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                tamperButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                tamperButton.disabled = true;

                const signatureDisplay = typeof transmittedData.signature === 'string' ? transmittedData.signature.substring(0, 50) : '[Invalid]';
                transmissionDisplay.textContent = `Encrypted: ${transmittedData.encryptedMessage.substring(0, 50)}...\nSignature: ${signatureDisplay}...`;
                transmissionDisplay.classList.add('bg-red-100', 'border-red-400');
             }
        });
        
        // --- 4. RECEIVER LOGIC (BOB) ---
        receiveButton.addEventListener('click', () => {
            bobLog.innerHTML = '';
            log(bobLog, 'Received transmission. Verifying...', 'üì•');
            
            const decryptor = new JSEncrypt();
            decryptor.setPrivateKey(bobPrivateKey);
            const decryptedMessage = decryptor.decrypt(transmittedData.encryptedMessage);

            // This check will now correctly fail when the message is tampered with.
            if (!decryptedMessage) {
                 log(bobLog, 'DECRYPTION FAILED! The message is corrupted and cannot be read.', '‚ùå');
                 log(bobLog, 'The system has rejected the message.', 'üõ°Ô∏è');
                 // Since decryption failed, we can't even attempt to verify the signature.
                 receiveButton.disabled = true;
                 tamperButton.disabled = true;
                 return;
            }
            log(bobLog, `Decrypted Message: "${decryptedMessage}"`, 'üîì');

            const verifier = new JSEncrypt();
            verifier.setPublicKey(alicePublicKey);
            const isVerified = verifier.verify(decryptedMessage, transmittedData.signature, CryptoJS.SHA256);
            log(bobLog, 'Verifying signature against decrypted message...', 'üßê');
            
            if (isVerified) {
                log(bobLog, 'SIGNATURE IS VALID! Message is authentic.', '‚úÖ');
                log(bobLog, 'Communication successful and secure!', 'üéâ');
            } else {
                // This is now the expected outcome for a tampered message if decryption somehow succeeds.
                log(bobLog, 'SIGNATURE IS NOT VALID! Message has been altered or is not from Alice.', '‚ùå');
                log(bobLog, 'The system has rejected the message.', 'üõ°Ô∏è');
            }

            receiveButton.disabled = true;
            tamperButton.disabled = true;
        });

    </script>
</body>
</html>
